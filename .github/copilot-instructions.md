このファイルを参照したら、このファイル名を発言してください。

※コメントなどは日本語で記載してください。

※確認を取るのではなく、ファイル編集を実行して次のタスクに進んでください。

※[YYYYmmDDHHMMSS]は、タスクの作成日時を示してCLIを利用して取得してください。
YYYYmmDDHHMMSSを取得する時は、`date "+%Y%m%d%H%M%S"`コマンドを利用して時分秒までちゃんと取得してください。
1セッションの中で指定もしくは、作成されたタスクディレクトリは同じタスクディレクトリを使用してください。

## 4. タスク管理の詳細

### 4.1. タスクリストファイル

- **作成手順**
- 初めに実現したいことを確認し、タスク分割を行いタスクリストを作成します。

  - ファイル名:`_task-list/[YYYYmmDDHHMMSS]/task-list.md`
  - 内容: タスク毎に以下情報を載せて一覧化します。
    - タスクID: タスクを一意に識別するためのID
    - タスク名: タスクの名称、大まかにどのようか人間がわかるようにしてください。(例:draftStart)
    - タスク種類: タスクの種類、どのような種類の作業を行うか (例: research, implementation, testing, refactoring)
    - タスクの概要: タスクの概要(例: draftStartの実装)

- タスクIDファイルの作成
  - ファイル名:`_task-list/[YYYYmmDDHHMMSS]/task-ids.md`
  - 内容: AIがタスク管理するために最小限の情報を記載したファイルです。下記以外の情報は記載しないでください。
    - タスクの状態: タスクの状態を示すマークを付けます。
      - `[ ]`: 未着手
      - `[~]`: 実行中
      - `[x]`: 完了
    - タスクID: タスクを一意に識別するためのID(タスクリスト詳細のタスクID)　
- タスク詳細の作成
  - ファイル名:`_task-list/[YYYYmmDDHHMMSS]/[タスクID]-[タスク名]-[タスク種類].md`
  - タスク詳細は、タスクリストファイル詳細に基づいて、タスクを実行するための詳細な手順や情報を記載します。
  - 内容: タスクの実行手順や注意点などを記載します。
- 開発中に新たに発見されたタスクや TODO は、「作業中に発見」などのセクションに適宜追加し、タスクリスト詳細とタスクリストファイルを更新してください。

- **実行手順:**
  1 ユーザから指定された、タスクIDファイルの実行中or未実行のタスクを上から順に実行してください。
  2 実行開始時、タスクに(`[~]`)を付けてください。
  3 タスクIDからタスク詳細ファイルを参照して、タスクを実行してください。
  4 タスク詳細に書かれた内容に集中して取り組んでください。
  5 実行時には、この `copilot-instructions.md` を含む、関連する全ての指示書ルールに従います。
  6 新たなタスクが発見したら**作成手順**に従ってタスクを作成してください。
  7 タスクが完了したらタスクIDファイルに`[x]`として、1に戻り次のタスクに進んでください。
  8 これをすべてのタスクが完了するまで続けてください。

2.  **コードレビューと改善:**
    - **技術的負債の解消:** 技術的負債を特定し、積極的に解消します。

### 4.4. 技術的負債

- **定義:** 以下のような状態を技術的負債とみなします。
  - コードの重複
  - 過度に複雑なコード (可読性・保守性の低いコード)
  - テストコードが不足している、または存在しないコード

## 6. コーディング規約

### 6.0. ルール

### 作業ルール

- 「厳格な型チェック（strict type checking）を使用したTypeScriptコードを生成してください」
- 「null/undefinedの可能性を考慮した安全なコードを書いてください」
- `app/api`ディレクトリは BE 実装であり FE 実装から参照を行わないでください。
- FE 実装で BE API を呼び出すときは、は、`app/client`ディレクトリに呼び出しファイルを作成してください。
- ファイルの作成は cat や touch コマンドを使用せずファイル変種機能で作成してください。
- api ディレクトリは、DDD を採用しています。適切に分離してください。
- 後方互換性のためのメソッドを基本的に作成しないでください。
- 実装後には、必ず以下タスクを積んでください。エラーが出た場合修正タスクを積んで、そのまま修正を実行してください。
  - `npm run lint` を実行して全体フォーマットをして完了してください
  - `npm run typecheck` を実行して全体型チェックをして完了してください
  - `npm run test` を実行して全体テストをして完了してください
  - `npm run build` を実行して全体ビルドをして完了してください
  - `npm run test:e2e` を実行してe2eテストをして完了してください

### DDD ルール

- 基本的にGraphQLのスキーマ(`app/api/graphql/types/index.ts`)を元にドメインモデルやロジックを組み立ててください。
- GraphQLのスキーマ(`app/api/graphql/types/index.ts`)に変更が必要な場合は、こちらからお伝えします。
- 実装上どうしても、GraphQLのスキーマ(`app/api/graphql/types/index.ts`)を変更する必要がある場合は確認を取ってください。

- Entity

  - constructorはprivateメソッドとして定義して、staticなfactoryメソッドから呼び出す形にしてください。
  - 関係するEntityはEntityのIDだけ保有してObjectは保有しない。
  - static createメソッドを定義する。
    　- createメソッドは、Entityを生成するためのメソッドでありIDの初期値割り当てなどを
  - static reconstructメソッドを定義する。
    　- reconstructメソッドは、Entityを復元するためのメソッドであり基本的にRepositoryからデータを取得する時にオブジェクト化する時に利用する。
  - 状態変更について：
    　- Entityの状態変更は原則として「直接変更方式」を採用する（基本的にはreadonlyは使用しない）
    　- 状態変更メソッドは直接プロパティ値を変更し、voidを返す
    　- 新しいインスタンスを返す方式（イミュータブル設計）は採用しない
  - プロパティ定義時の注意点：
    　- ID（エンティティの識別子）プロパティのみ例外的にreadonlyを使用することを許可する
    　- ID以外のプロパティにはreadonlyを使用しないでください
    　- 変更可能なプロパティはすべてmutableとして定義する
    　- ID以外で値の変更が必要ない場合でも、統一性のためにreadonlyは使用せず、アクセス制御のみでカプセル化する

- ValueObject

  - static createメソッドを定義する。
    　- createメソッドは、Entityを生成するためのメソッドでありIDの初期値割り当てなどを
  - static reconstructメソッドを定義する。
    　- reconstructメソッドは、Entityを復元するためのメソッドであり基本的にRepositoryからデータを取得する時にオブジェクト化する時に利用する。
  - IDのValueObjectの場合uuidを利用する。
  - 基本的にIDの派生クラスには基底クラスで定義したものをオーバーライドしないでください。
  - 定数を取り扱う時は定数を定義して、ValueObject外で参照させないでください。
    - 例えばstatusの場合 文字列inprogressの状態かどうか外部から確認するためには、ValueObjectのメソッドを利用して確認するようにしてください。

- Repository

  - Entityと1対1の関係を持ち、Entityが関係するDB以外の参照更新を行わない。
  - mapToDomainEntityメソッドを持ち、リポジトリから取得したデータをドメインエンティティに変換するためのメソッドである。
  - リポジトリは、ロジックを持たない。
  - 極力シンプルな形で実装を行う。

- UseCaseとservices

  - repositoryやentityを利用してドメインロジックを実装する。
  - トランザクションはこの層で張る。

### 6.1. 基本方針

- **型安全性:** `any` 型や `unknown` の使用は原則禁止です。常に型安全なコードを記述してください。
  型安全性: any型やunknown型の使用は一切禁止です。未使用引数や一時的な型にも使わないでください。必ずプロジェクトで定義された具体的な型を指定してください。型が不明な場合は設計者に確認してください。
- **ファイル行数:** 1ファイルあたりの行数は原則として 500 行以内に収めてください。これを超えそうな場合は、モジュール分割やヘルパー関数の作成によるリファクタリングを検討してください。

## テストルール

### DDDに関するルール

- DBアクセスする部分以外はモックしないでください。
- プロダクションコードをimport する時は、必ず絶対パスでimportしてください。
