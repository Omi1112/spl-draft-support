# 注意点ノウハウ

## GraphQL の実装に関する注意点

1. **スキーマファーストアプローチの徹底**

   - GraphQL ではスキーマが「契約」として機能します。リゾルバを実装する前に必ずスキーマ定義を先に行いましょう。
   - リゾルバに新しいクエリやミューテーションを追加する際は、必ず対応するスキーマ定義も追加・更新してください。

2. **変更の影響範囲を確認する**

   - 機能追加や修正を行う際は、以下のコンポーネント間の整合性を常に確認してください：
     - GraphQL スキーマ (app/api/graphql/types/index.ts)
     - GraphQL リゾルバ (app/api/graphql/resolvers/\*)
     - アプリケーション層のユースケース (app/api/core/application/useCases/\*)
     - クライアント側の呼び出しコード (app/client/\*.ts)

3. **作業前の確認事項**

   - 新機能追加時：スキーマ定義 → リゾルバ実装 → ユースケース実装 → クライアント実装の順序で作業
   - 既存機能修正時：修正によって影響を受けるすべてのレイヤーを特定し、一貫性を保つように修正

4. **テスト駆動開発の推奨**

   - スキーマとリゾルバの整合性を確認するテストを実装し、変更のたびに実行する
   - エラーは早期に発見することで、デプロイ後の問題を防止します

5. **リゾルバでの適切なレイヤー分離**

   - GraphQLリゾルバからドメイン層（リポジトリなど）に直接アクセスしないこと
   - リゾルバはアプリケーション層（ユースケース）のみを使用する実装に統一
   - 必要なユースケースが存在しない場合は、新たに作成してから実装を進める
   - データ変換処理はリゾルバ内に含めず、必要に応じてアプリケーション層に移動

6. **ユースケースの適切な命名と設計**
   - ユースケース名は「動作+対象+条件」の形式で統一する（例：`GetTournamentParticipantsByTournamentIdUseCase`）
   - 一つのユースケースは一つの責務のみを持ち、単一の機能を実現するように設計
   - 同様の操作を行う他のユースケースとの命名の一貫性を確保する
   - ファイル名とクラス名の一致を徹底する

## アーキテクチャの実装に関する注意点

1. **レイヤー間の明確な責務分離**

   - アプリケーション層（ユースケース）は直接データベースにアクセスしてはいけません
   - データアクセスは常にリポジトリインターフェースを通じて行う
   - ユースケースはドメイン層のリポジトリインターフェースに依存し、実装の詳細を知らない設計を維持する

2. **依存性の方向に注意する**

   - 内側の層（ドメイン・アプリケーション）は外側の層（インフラストラクチャ）に依存してはいけない
   - インフラストラクチャの詳細（PrismaClientなど）がアプリケーション層に漏れていないか確認する
   - 依存性逆転の原則を守り、テスト容易性と疎結合を維持する

3. **リポジトリとドメインロジックの厳格な分離**
   - リポジトリはCRUDのような基本的なデータアクセス操作のみを提供し、ドメインロジックを含めないこと
   - ドメインに特化したビジネスルールはエンティティやドメインサービスに実装する
   - メソッド名だけでなく、リポジトリの実装コードもレビューし、隠れたドメインロジックがないか確認する
   - リファクタリング作業を行う際は、移行が完全に行われているか最終確認チェックリストを実行する

## テスト生成に関する注意点

1. **インターフェースと実装の一致を確認**

   - テスト作成前にリポジトリインターフェースと実装（モック含む）の整合性を確認する
   - 特にバリューオブジェクト（ID型）を引数に取るメソッドのシグネチャに注意する
   - モックリポジトリの実装は実際のリポジトリインターフェースに100%準拠させる

2. **テストヘルパーの設計と保守**

   - ファクトリ関数は実際のエンティティのコンストラクタシグネチャと一致させる
   - テスト用ファクトリとモックの命名規則を統一し、名前衝突を避ける
   - テストヘルパーファイル名はJestのテストファイルとして認識されないよう注意する

3. **段階的なテスト開発**

   - 複雑なテストは小さな単位で実装・検証し、徐々に構築する
   - 一度に大きな変更を行わず、小さな変更ごとにテスト実行して問題を早期発見する
   - エラーメッセージを注意深く分析し、根本原因を特定してから修正に取り組む

4. **テスト間の独立性確保**

   - 各テストは独立して実行できるよう、適切な前提条件を`beforeEach`で設定する
   - テスト間で共有する状態は最小限に抑え、テストの順序依存性を排除する
   - テストが失敗した場合、他のテストへの影響を最小化する設計を心がける

5. **エラーケースの網羅的テスト**
   - 正常系だけでなく、境界条件や異常系のテストケースを十分に用意する
   - エラーメッセージの内容まで正確に検証する
   - エッジケースや例外的なシナリオのテスト漏れがないか確認する
