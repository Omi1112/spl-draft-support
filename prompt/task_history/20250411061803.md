# 事前読み込み

- prompt/index.md
- prompt/rule.md
- prompt/dir.md
- prompt/reflection.md

# タスク

## TODO リスト

1. **api/core ディレクトリの現状分析**

   - api/core/domain ディレクトリの Entity クラスの確認
   - api/core/domain ディレクトリの ValueObject クラスの確認
   - api/core/domain ディレクトリの Repository インターフェースの確認
   - api/core/application ディレクトリの UseCase の確認
   - api/core/infrastructure ディレクトリの Repository 実装の確認

2. **Entity のリファクタリング**

   - 関連 Entity をオブジェクトではなく ID のみ保持するよう修正
   - static create メソッドの実装（ID の初期値割り当て含む）
   - static reconstruct メソッドの実装

3. **ValueObject のリファクタリング**

   - static create メソッドの実装
   - static reconstruct メソッドの実装
   - ID の ValueObject に UUID を利用するよう修正

4. **Repository のリファクタリング**

   - Entity との 1対1 の関係を確認・修正
   - mapToDomainEntity メソッドの実装
   - DB 以外の参照更新を行っていないか確認・修正
   - シンプルな実装への改善

5. **UseCase とサービスのリファクタリング**

   - Repository や Entity を利用したドメインロジックの実装確認
   - トランザクションが適切な層で実装されているか確認・修正

6. **テスト作成・修正**

   - リファクタリングした Entity のテスト作成
   - リファクタリングした ValueObject のテスト作成
   - リファクタリングした Repository のテスト作成
   - リファクタリングした UseCase のテスト作成

7. **全体の動作確認**
   - 既存のテストが全てパスすることを確認
   - 新規テストが全てパスすることを確認
   - GraphQL API の動作確認

## DDDルールの重要ポイント

- **Entity**

  - 関係する Entity は Entity の ID だけ保有し、Object は保有しない
  - static create メソッドを定義し、Entity 生成とID初期値割り当てを行う
  - static reconstruct メソッドを定義し、Repository からデータ取得時にオブジェクト化を行う

- **ValueObject**

  - static create メソッドを定義
  - static reconstruct メソッドを定義
  - ID の ValueObject は uuid を利用する

- **Repository**

  - Entity と 1対1 の関係を持つ
  - Entity が関係する DB 以外の参照更新を行わない
  - mapToDomainEntity メソッドを実装し、リポジトリデータをドメインエンティティに変換
  - ロジックを持たない
  - シンプルな実装を心がける

- **UseCase と services**
  - repository や entity を利用してドメインロジックを実装
  - トランザクションはこの層で実装する

## 注意点

- GraphQL の実装に関する整合性を保つ
  - スキーマ、リゾルバ、アプリケーション層、クライアント側の一貫性に注意
- レイヤー間の責務分離を維持

  - 依存関係の方向を守る（内側の層は外側の層に依存しない）
  - インフラストラクチャの詳細がアプリケーション層に漏れないようにする

- リポジトリとドメインロジックの分離

  - リポジトリは基本的なデータアクセス操作のみを提供
  - ドメインロジックはエンティティやドメインサービスに実装

- テスト関連
  - インターフェースと実装の一致を確認
  - モックリポジトリは実際のリポジトリインターフェースに100%準拠させる
  - テスト間の独立性を確保する
  - エラーケースを含む網羅的なテストを作成する
